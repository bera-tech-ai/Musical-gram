<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChegeTech Premium | Affordable Digital Subscriptions</title>
    <meta name="description" content="Get premium subscriptions for Netflix, YouTube, Spotify, and more at affordable prices. One flat rate for all platforms.">
    <meta name="keywords" content="netflix, youtube premium, spotify, telegram premium, showmax, apple music, amazon prime, disney+, deezer, kenya, mpesa">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ‘‘</text></svg>">
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <a href="#" class="logo">
                    <div class="logo-icon">C</div>
                    <div class="logo-text">Chege<span class="logo-accent">Tech</span></div>
                </a>
                <nav>
                    <ul>
                        <li><a href="#home">Home</a></li>
                        <li><a href="#plans">Plans</a></li>
                        <li><a href="#referral">Refer & Earn</a></li>
                        <li><a href="#contact">Contact</a></li>
                    </ul>
                </nav>
                <div class="auth-buttons">
                    <button class="btn btn-secondary" id="login-btn">Login</button>
                    <button class="btn btn-primary" id="signup-btn">Sign Up</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero" id="home">
        <div class="container">
            <h1>Premium Subscriptions Made Simple</h1>
            <p>Access Netflix, YouTube Premium, Spotify, and all your favorite platforms with one simple payment. No hidden fees, no complicated processes.</p>
            <div class="hero-buttons">
                <button class="btn btn-primary" id="get-started-btn">Get Started Now</button>
                <button class="btn btn-secondary" id="learn-more-btn">How It Works</button>
            </div>
        </div>
    </section>

    <!-- Subscription Plans -->
    <section class="plans-section" id="plans">
        <div class="container">
            <div class="section-title">
                <h2>Choose Your Platform</h2>
                <p>All premium subscriptions available for one flat rate. Select your preferred platform and get instant access.</p>
            </div>
            <div class="plans-grid" id="plans-grid">
                <!-- Plans populated by JavaScript -->
            </div>
        </div>
    </section>

    <!-- Referral Section -->
    <section class="referral-section" id="referral">
        <div class="container">
            <div class="referral-content">
                <div class="referral-text">
                    <h2>Refer Friends & Earn Money</h2>
                    <p>Share your unique referral link with friends and earn KES 20 for every successful subscription they purchase. It's that simple!</p>
                    <button class="btn btn-primary" id="get-referral-btn">Get Your Referral Link</button>
                    
                    <div class="referral-stats">
                        <div class="stat">
                            <div class="stat-number" id="total-earnings">KES 0</div>
                            <div class="stat-label">Total Earnings</div>
                        </div>
                        <div class="stat">
                            <div class="stat-number" id="total-referrals">0</div>
                            <div class="stat-label">Successful Referrals</div>
                        </div>
                    </div>
                </div>
                <div class="referral-visual">
                    <div class="referral-box">
                        <div class="referral-icon">
                            <i class="fas fa-gift"></i>
                        </div>
                        <h3>Your Referral Code</h3>
                        <div class="referral-code" id="referral-code-display">CHTECH-<span id="user-ref-code">LOADING...</span></div>
                        <p>Share this code with friends to earn KES 20 for each purchase</p>
                        <button class="btn btn-secondary" id="copy-referral-btn">
                            <i class="fas fa-copy"></i> Copy Referral Link
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Payment Modal -->
    <div class="modal" id="payment-modal">
        <div class="modal-content">
            <span class="close-modal" id="close-modal">&times;</span>
            
            <div class="alert alert-success" id="success-alert">
                <i class="fas fa-check-circle"></i>
                <span id="success-message">Payment successful! Redirecting to WhatsApp for activation...</span>
            </div>
            
            <div class="alert alert-error" id="error-alert">
                <i class="fas fa-exclamation-circle"></i>
                <span id="error-message">Payment failed. Please try again.</span>
            </div>
            
            <div class="alert alert-warning" id="warning-alert">
                <i class="fas fa-info-circle"></i>
                <span id="warning-message">Please check your phone and enter your M-Pesa PIN</span>
            </div>

            <h2 class="modal-title" id="modal-title">Subscribe to Platform</h2>
            <p class="modal-subtitle" id="modal-subtitle">Complete your subscription with M-Pesa</p>
            
            <form id="payment-form">
                <div class="form-group">
                    <label for="phone">M-Pesa Phone Number</label>
                    <input type="tel" id="phone" class="form-control" placeholder="2547XXXXXXXX" required>
                    <small style="color: var(--text-secondary); margin-top: 5px; display: block;">
                        Format: 2547XXXXXXXX (e.g., 254712345678)
                    </small>
                </div>
                
                <div class="form-group">
                    <label for="email">Email Address (Optional)</label>
                    <input type="email" id="email" class="form-control" placeholder="your@email.com">
                </div>

                <div class="loading" id="payment-loading">
                    <div class="spinner"></div>
                    <p>Processing your payment...</p>
                </div>
                
                <button type="submit" class="subscribe-btn" id="pay-btn">
                    <i class="fas fa-lock"></i> Pay KES 100 via M-Pesa
                </button>
                
                <div class="text-center mt-20">
                    <small style="color: var(--text-secondary);">
                        <i class="fas fa-shield-alt"></i> Your payment is secure and encrypted
                    </small>
                </div>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <footer id="contact">
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <h3>ChegeTech Premium</h3>
                    <p>Your trusted platform for affordable premium subscriptions. Access all your favorite services with one simple payment.</p>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-facebook-f"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-whatsapp"></i></a>
                    </div>
                </div>
                <div class="footer-column">
                    <h3>Quick Links</h3>
                    <ul>
                        <li><a href="#home">Home</a></li>
                        <li><a href="#plans">Subscription Plans</a></li>
                        <li><a href="#referral">Referral Program</a></li>
                        <li><a href="#">FAQ</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Support</h3>
                    <ul>
                        <li><a href="#">Contact Us</a></li>
                        <li><a href="#">Privacy Policy</a></li>
                        <li><a href="#">Terms of Service</a></li>
                        <li><a href="#">Refund Policy</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Contact Info</h3>
                    <ul>
                        <li><i class="fas fa-envelope"></i> support@chegetech.com</li>
                        <li><i class="fas fa-phone"></i> +254 743 982 206</li>
                        <li><i class="fas fa-map-marker-alt"></i> Nairobi, Kenya</li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>Developed by Bera Tech â€” All Rights Reserved Â© 2025.</p>
            </div>
        </div>
    </footer>

    <script>
        // Subscription plans data
        const subscriptionPlans = [
            {
                id: 'netflix',
                name: 'Netflix',
                icon: 'fab fa-netflix',
                color: '#E50914',
                description: '1-Month Premium Subscription',
                features: ['HD & Ultra HD Quality', 'Watch on 4 devices', 'Unlimited movies & TV shows', 'Download for offline viewing']
            },
            {
                id: 'youtube',
                name: 'YouTube Premium',
                icon: 'fab fa-youtube',
                color: '#FF0000',
                description: '1-Month Premium Subscription',
                features: ['Ad-free videos', 'Background play', 'Offline downloads', 'YouTube Music included']
            },
            {
                id: 'spotify',
                name: 'Spotify',
                icon: 'fab fa-spotify',
                color: '#1DB954',
                description: '1-Month Premium Subscription',
                features: ['Ad-free music', 'Download songs', 'High quality audio', 'Unlimited skips']
            },
            {
                id: 'telegram',
                name: 'Telegram Premium',
                icon: 'fab fa-telegram',
                color: '#0088cc',
                description: '1-Month Premium Subscription',
                features: ['4GB file uploads', 'Faster downloads', 'Premium stickers', 'Advanced chat management']
            },
            {
                id: 'showmax',
                name: 'Showmax',
                icon: 'fas fa-tv',
                color: '#FF00FF',
                description: '1-Month Premium Subscription',
                features: ['Local & international content', 'Multiple profiles', 'Download to watch offline', 'HD streaming']
            },
            {
                id: 'apple-music',
                name: 'Apple Music',
                icon: 'fab fa-apple',
                color: '#FA243C',
                description: '1-Month Premium Subscription',
                features: ['70+ million songs', 'Ad-free listening', 'Download music', 'Spatial Audio']
            },
            {
                id: 'amazon-prime',
                name: 'Amazon Prime Video',
                icon: 'fab fa-amazon',
                color: '#00A8E1',
                description: '1-Month Premium Subscription',
                features: ['Thousands of movies & TV shows', 'Award-winning originals', 'Download to watch offline', '4K Ultra HD']
            },
            {
                id: 'disney-plus',
                name: 'Disney+',
                icon: 'fas fa-hat-wizard',
                color: '#0063E5',
                description: '1-Month Premium Subscription',
                features: ['Disney, Pixar, Marvel, Star Wars', 'Exclusive originals', '4K UHD & HDR', 'GroupWatch feature']
            },
            {
                id: 'deezer',
                name: 'Deezer',
                icon: 'fas fa-music',
                color: '#A0D9EF',
                description: '1-Month Premium Subscription',
                features: ['73+ million tracks', 'High Fidelity sound', 'Offline mode', 'Personalized recommendations']
            }
        ];

        // DOM Elements
        const plansGrid = document.getElementById('plans-grid');
        const paymentModal = document.getElementById('payment-modal');
        const closeModal = document.getElementById('close-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalSubtitle = document.getElementById('modal-subtitle');
        const paymentForm = document.getElementById('payment-form');
        const phoneInput = document.getElementById('phone');
        const payBtn = document.getElementById('pay-btn');
        const paymentLoading = document.getElementById('payment-loading');
        const successAlert = document.getElementById('success-alert');
        const errorAlert = document.getElementById('error-alert');
        const warningAlert = document.getElementById('warning-alert');
        const successMessage = document.getElementById('success-message');
        const errorMessage = document.getElementById('error-message');
        const warningMessage = document.getElementById('warning-message');
        const referralCodeDisplay = document.getElementById('user-ref-code');
        const copyReferralBtn = document.getElementById('copy-referral-btn');
        const getReferralBtn = document.getElementById('get-referral-btn');

        // Global variables
        let currentPlan = null;
        let currentTransactionRef = null;
        let statusCheckInterval = null;
        let userReferralCode = '';

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            renderPlans();
            setupReferralSystem();
            setupEventListeners();
            await generateUserReferralCode();
        }

        function renderPlans() {
            plansGrid.innerHTML = '';
            
            subscriptionPlans.forEach(plan => {
                const planCard = document.createElement('div');
                planCard.className = 'plan-card fade-in';
                planCard.innerHTML = `
                    <div class="plan-header">
                        <div class="plan-icon" style="color: ${plan.color}">
                            <i class="${plan.icon}"></i>
                        </div>
                        <h3 class="plan-name">${plan.name}</h3>
                        <p class="plan-description">${plan.description}</p>
                    </div>
                    <div class="plan-price">
                        <div class="price-amount">KES 100</div>
                        <div class="price-period">per month â€¢ One-time payment</div>
                    </div>
                    <div class="plan-features">
                        <ul>
                            ${plan.features.map(feature => `
                                <li>
                                    <i class="fas fa-check" style="color: ${plan.color}"></i>
                                    ${feature}
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                    <div class="plan-actions">
                        <button class="subscribe-btn" data-plan="${plan.id}" style="background: linear-gradient(135deg, ${plan.color} 0%, ${plan.color}99 100%)">
                            Subscribe to ${plan.name}
                        </button>
                    </div>
                `;
                
                plansGrid.appendChild(planCard);
            });
        }

        function setupEventListeners() {
            // Subscribe button clicks
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('subscribe-btn')) {
                    const planId = e.target.getAttribute('data-plan');
                    openPaymentModal(planId);
                }
            });
            
            // Modal controls
            closeModal.addEventListener('click', closePaymentModal);
            window.addEventListener('click', function(e) {
                if (e.target === paymentModal) {
                    closePaymentModal();
                }
            });
            
            // Form submission
            paymentForm.addEventListener('submit', processPayment);
            
            // Phone number formatting
            phoneInput.addEventListener('input', formatPhoneNumber);
            
            // Referral system
            copyReferralBtn.addEventListener('click', copyReferralLink);
            getReferralBtn.addEventListener('click', generateNewReferralCode);
            
            // Navigation buttons
            document.getElementById('get-started-btn').addEventListener('click', () => {
                document.getElementById('plans').scrollIntoView({ behavior: 'smooth' });
            });
        }

        function setupReferralSystem() {
            const urlParams = new URLSearchParams(window.location.search);
            const refCode = urlParams.get('ref');
            
            if (refCode) {
                // Store referral code for use during payment
                localStorage.setItem('referralCode', refCode);
                console.log(`Referral detected: ${refCode}`);
                
                // Show notification
                showTemporaryAlert(`You were referred by ${refCode}! You'll earn KES 20 when you complete your purchase.`, 'success');
            }
        }

        async function generateUserReferralCode() {
            try {
                // In a real app, this would come from your backend based on user auth
                // For demo, we'll generate a random one
                const randomCode = `USER${Math.random().toString(36).substr(2, 8).toUpperCase()}`;
                userReferralCode = randomCode;
                referralCodeDisplay.textContent = randomCode;
                
                // Store in localStorage for persistence
                localStorage.setItem('userReferralCode', randomCode);
            } catch (error) {
                console.error('Error generating referral code:', error);
                // Fallback to localStorage or generate random
                userReferralCode = localStorage.getItem('userReferralCode') || 
                                 `USER${Math.random().toString(36).substr(2, 8).toUpperCase()}`;
                referralCodeDisplay.textContent = userReferralCode;
            }
        }

        function generateNewReferralCode() {
            generateUserReferralCode();
            showTemporaryAlert('New referral code generated!', 'success');
        }

        function copyReferralLink() {
            const referralLink = `${window.location.origin}${window.location.pathname}?ref=${userReferralCode}`;
            
            navigator.clipboard.writeText(referralLink).then(() => {
                showTemporaryAlert('Referral link copied to clipboard!', 'success');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = referralLink;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showTemporaryAlert('Referral link copied to clipboard!', 'success');
            });
        }

        function openPaymentModal(planId) {
            currentPlan = subscriptionPlans.find(plan => plan.id === planId);
            
            if (currentPlan) {
                modalTitle.textContent = `Subscribe to ${currentPlan.name}`;
                modalSubtitle.textContent = `Get instant access to ${currentPlan.name} Premium for 1 month`;
                paymentModal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                
                // Reset form and alerts
                paymentForm.reset();
                hideAlerts();
            }
        }

        function closePaymentModal() {
            paymentModal.style.display = 'none';
            document.body.style.overflow = 'auto';
            currentPlan = null;
            currentTransactionRef = null;
            
            // Clear any existing status checks
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
                statusCheckInterval = null;
            }
        }

        function formatPhoneNumber() {
            let value = phoneInput.value.replace(/\D/g, '');
            
            if (value.startsWith('0')) {
                value = '254' + value.substring(1);
            } else if (value.startsWith('7')) {
                value = '254' + value;
            } else if (value.startsWith('1')) {
                value = '254' + value;
            }
            
            phoneInput.value = value;
        }

        function hideAlerts() {
            successAlert.style.display = 'none';
            errorAlert.style.display = 'none';
            warningAlert.style.display = 'none';
        }

        function showTemporaryAlert(message, type) {
            // Create a temporary alert element
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                z-index: 3000;
                max-width: 300px;
            `;
            alert.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check' : 'exclamation'}-circle"></i>
                ${message}
            `;
            
            document.body.appendChild(alert);
            
            // Remove after 5 seconds
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        async function processPayment(e) {
            e.preventDefault();
            
            const phone = phoneInput.value.trim();
            const email = document.getElementById('email').value.trim();
            const referralCode = localStorage.getItem('referralCode');
            
            // Validate phone number
            if (!phone || !/^2547\d{8}$/.test(phone)) {
                errorMessage.textContent = 'Please enter a valid M-Pesa phone number (2547XXXXXXXX)';
                errorAlert.style.display = 'flex';
                return;
            }

            // Disable form and show loading
            payBtn.disabled = true;
            paymentLoading.style.display = 'block';
            hideAlerts();

            try {
                // Initiate STK Push
                const response = await fetch('/api/payhero/stkpush', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        phone: phone,
                        plan: currentPlan.id,
                        referralCode: referralCode,
                        email: email
                    })
                });

                const result = await response.json();

                if (result.success) {
                    currentTransactionRef = result.transactionRef;
                    
                    // Show waiting message
                    warningMessage.textContent = result.message;
                    warningAlert.style.display = 'flex';
                    
                    // Start polling for transaction status
                    startStatusPolling(result.transactionRef);
                } else {
                    throw new Error(result.message || 'Failed to initiate payment');
                }
            } catch (error) {
                console.error('Payment Error:', error);
                errorMessage.textContent = error.message;
                errorAlert.style.display = 'flex';
                
                // Re-enable form
                payBtn.disabled = false;
                paymentLoading.style.display = 'none';
            }
        }

        function startStatusPolling(transactionRef) {
            // Check status every 3 seconds
            statusCheckInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/transaction/${transactionRef}/status`);
                    const result = await response.json();
                    
                    if (result.success) {
                        if (result.status === 'completed') {
                            // Payment successful
                            clearInterval(statusCheckInterval);
                            paymentSuccess();
                        } else if (result.status === 'failed' || result.status === 'cancelled') {
                            // Payment failed
                            clearInterval(statusCheckInterval);
                            paymentFailed('Payment was cancelled or failed. Please try again.');
                        }
                        // If still pending, continue polling
                    }
                } catch (error) {
                    console.error('Status check error:', error);
                }
            }, 3000);

            // Timeout after 2 minutes
            setTimeout(() => {
                if (statusCheckInterval) {
                    clearInterval(statusCheckInterval);
                    paymentFailed('Payment timeout. Please try again.');
                }
            }, 120000);
        }

        function paymentSuccess() {
            // Show success message
            successMessage.textContent = 'Payment successful! Redirecting to WhatsApp for activation...';
            successAlert.style.display = 'flex';
            warningAlert.style.display = 'none';
            paymentLoading.style.display = 'none';
            
            // Clear referral code from localStorage after successful payment
            localStorage.removeItem('referralCode');
            
            // Redirect to WhatsApp after 3 seconds
            setTimeout(() => {
                window.location.href = 'https://wa.me/254743982206';
            }, 3000);
        }

        function paymentFailed(message) {
            errorMessage.textContent = message;
            errorAlert.style.display = 'flex';
            warningAlert.style.display = 'none';
            paymentLoading.style.display = 'none';
            payBtn.disabled = false;
        }

        // Export functions for global access (if needed)
        window.ChegeTechApp = {
            openPaymentModal,
            closePaymentModal,
            generateNewReferralCode
        };
    </script>
</body>
  </html>
